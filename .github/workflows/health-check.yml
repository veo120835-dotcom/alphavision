name: Agent Health Guardrail

on:
  push:
    branches: [main, production]
  schedule:
    - cron: '0 8 * * *' # Runs every morning at 8 AM UTC automatically

jobs:
  health-check:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install Dependencies
        run: npm ci
      
      - name: Build Project
        run: npm run build
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_PUBLISHABLE_KEY: ${{ secrets.VITE_SUPABASE_PUBLISHABLE_KEY }}
      
      - name: Run Health Check Tests
        run: npm run test:health
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          LOVABLE_API_KEY: ${{ secrets.LOVABLE_API_KEY }}
      
      - name: Alert Team on Failure
        if: failure()
        run: |
          curl -X POST -H 'Content-type: application/json' \
          --data '{"text":"ðŸš¨ Agent Health Check Failed! Branch: ${{ github.ref_name }} | Commit: ${{ github.sha }} | Check logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"}' \
          ${{ secrets.SLACK_WEBHOOK_URL }}
        continue-on-error: true

  reflexion-eval:
    runs-on: ubuntu-latest
    needs: health-check
    if: github.event_name == 'schedule' # Only run evals on scheduled runs
    timeout-minutes: 30
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install Dependencies
        run: npm ci
      
      - name: Run Automated Reflexion Eval
        run: npm run test:reflexion
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          LOVABLE_API_KEY: ${{ secrets.LOVABLE_API_KEY }}
      
      - name: Report Eval Results
        if: always()
        run: |
          curl -X POST -H 'Content-type: application/json' \
          --data '{"text":"ðŸ“Š Daily Reflexion Eval Complete | Status: ${{ job.status }} | See results: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"}' \
          ${{ secrets.SLACK_WEBHOOK_URL }}
        continue-on-error: true

  meta-evolution-weekly:
    runs-on: ubuntu-latest
    if: github.event.schedule == '0 8 * * 0' # Only on Sundays
    timeout-minutes: 45
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install Dependencies
        run: npm ci
      
      - name: Run Meta-Evolution Analysis
        run: npm run evolution:analyze
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          LOVABLE_API_KEY: ${{ secrets.LOVABLE_API_KEY }}
      
      - name: Notify Evolution Results
        if: always()
        run: |
          curl -X POST -H 'Content-type: application/json' \
          --data '{"text":"ðŸ§¬ Weekly Meta-Evolution Complete | Prompts may have been optimized | Status: ${{ job.status }}"}' \
          ${{ secrets.SLACK_WEBHOOK_URL }}
        continue-on-error: true
